name: Build and Deploy (GitHub Pages)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Setup Python (for nbconvert)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system deps (ImageMagick)
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
          pip3 install --upgrade nbconvert

      - name: Setup Typst
        uses: typst-community/setup-typst@v3

      - name: Build CV (Typst)
        run: |
          set -euxo pipefail
          # Clone MyCV repo (public)
          git clone --depth 1 https://github.com/andylizf/MyCV.git MyCV
          cd MyCV
          git submodule update --init --recursive || true
          # Fetch fonts locally
          FONTS_DIR="$GITHUB_WORKSPACE/.fonts"
          mkdir -p "$FONTS_DIR/roboto" "$FONTS_DIR/source-sans-pro" "$FONTS_DIR/font-awesome"
          curl -L "https://fonts.google.com/download?family=Roboto" -o "$FONTS_DIR/roboto.zip"
          unzip -o "$FONTS_DIR/roboto.zip" -d "$FONTS_DIR/roboto" && rm "$FONTS_DIR/roboto.zip"
          curl -L "https://github.com/adobe-fonts/source-sans-pro/archive/refs/tags/3.046R.zip" -o "$FONTS_DIR/source-sans.zip"
          unzip -o "$FONTS_DIR/source-sans.zip" -d "$FONTS_DIR/source-sans-pro" && rm "$FONTS_DIR/source-sans.zip"
          curl -L "https://use.fontawesome.com/releases/v6.4.2/fontawesome-free-6.4.2-desktop.zip" -o "$FONTS_DIR/fontawesome.zip"
          unzip -o "$FONTS_DIR/fontawesome.zip" -d "$FONTS_DIR/font-awesome" && rm "$FONTS_DIR/fontawesome.zip"
          # Compile Typst to the website's cv folder
          export TYPST_FONT_PATHS="$FONTS_DIR"
          typst compile resume.typ "$GITHUB_WORKSPACE/cv/andylizf_cv.pdf"

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Build site
        env:
          JEKYLL_ENV: production
        run: bundle exec jekyll build --trace

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
